{
	order handle before root
}

# Main site with automatic HTTPS
__#TEMPLATE#:DOMAIN__ {
	log access-file {
		output file /var/log/caddy/access.log
	}
	log access-stdout {
		output stdout
	}

	@badbots {
		header User-Agent *GPTBot*
		header User-Agent *Claude-Web*
		header User-Agent *CCBot*
		header User-Agent *bytespider*
		header User-Agent *PerplexityBot*
	}
	respond @badbots 403

handle /honeypot {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /wp-admin* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /wp-content* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /wp-includes* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /wordpress* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /wp-login.php {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /xmlrpc.php {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /admin* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /administrator* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /manager* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /phpmyadmin* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /phpMyAdmin* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /pma* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /cpanel* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /.env* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /config* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /.git* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /.htaccess {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /backup* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /backups* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /db* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /database* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /dump* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /api/v1/admin* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /api/admin* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /rest/api* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /shell* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /webshell* {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /c99.php {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}
handle /r57.php {
	header X-Honeypot "trapped"
	respond "HONEYPOT TRIGGERED" 403
}

# Cache static assets with content hashes (immutable)
handle /_astro/* {
	header Cache-Control "public, max-age=31536000, immutable"
	root * /srv
	encode zstd gzip
	try_files {path} {path}/index.html {path}.html
	file_server {
		precompressed br zstd gzip
	}
}

# Cache favicon for 1 week
handle /favicon.svg {
	header Cache-Control "public, max-age=604800"
	header -Accept-Ranges
	header Content-Type "image/svg+xml"
	root * /srv
	encode zstd gzip
	file_server {
		precompressed br zstd gzip
	}
}

# HTML pages should always revalidate (SPA navigation)
handle /*.html {
	header Cache-Control "public, max-age=0, must-revalidate"
	header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
	header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
	root * /srv
	try_files {path} {path}/index.html {path}.html
	file_server {
		precompressed br zstd gzip
	}
}

# Serve image files (no compression needed - already compressed)
handle /*.jpg {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}
handle /*.jpeg {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}
handle /*.png {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}
handle /*.webp {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}
handle /*.gif {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}
handle /*.ico {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}
handle /*.avif {
	header Cache-Control "public, max-age=604800"
	root * /srv
	file_server
}

# Serve everything else as static files
handle {
	header Cache-Control "public, max-age=3600"
	root * /srv
	encode zstd gzip
	try_files {path} {path}/index.html {path}.html
	file_server {
		precompressed br zstd gzip
	}
}

	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy strict-origin-when-cross-origin
	}

	handle_errors {
		@404 expression `{err.status_code} == 404`
		handle @404 {
			rewrite * /404.html
			file_server {
				root /srv
				precompressed br zstd gzip
			}
		}
	}
}

www.__#TEMPLATE#:DOMAIN__ {
	redir https://__#TEMPLATE#:DOMAIN__{uri} permanent
}

logs.__#TEMPLATE#:DOMAIN__ {
	basic_auth {
		{$LOGS_USERNAME} {$LOGS_PASSWORD_HASH}
	}
	reverse_proxy dozzle:8080
}
